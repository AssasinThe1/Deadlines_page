<!doctype html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Assignment Countdowns</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --radius: 18px; --shadow: 0 10px 30px rgba(0,0,0,.35);
      --accent:#7c5cff; --good:#08c894; --warn:#ffb020; --bad:#ff4d4f;

      /* light defaults (overridden by [data-theme]) */
      --bg1:#f7f8fb; --bg2:#e8ebf3; --text:#0f1a2b; --muted:#3a4961; --panel: rgba(255,255,255,.85);
      --card1: rgba(255,255,255,.95); --card2: rgba(255,255,255,.88); --link:#0b6bcb;
      --glass: rgba(0,0,0,.03); --glass-brd: rgba(0,0,0,.10);
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg1:#0f1021; --bg2:#17182e; --text:#e9ecf1; --muted:#b7c3d6; --panel: rgba(20,24,38,.75);
        --card1: rgba(255,255,255,.10); --card2: rgba(255,255,255,.06); --link:#9ad1ff;
        --glass: rgba(255,255,255,.08); --glass-brd: rgba(255,255,255,.22); }
    }
    [data-theme="light"]{
      --bg1:#f7f8fb; --bg2:#e8ebf3; --text:#0f1a2b; --muted:#3a4961; --panel: rgba(255,255,255,.85);
      --card1: rgba(255,255,255,.95); --card2: rgba(255,255,255,.88); --link:#0b6bcb;
      --glass: rgba(0,0,0,.03); --glass-brd: rgba(0,0,0,.10);
    }
    [data-theme="dark"]{
      --bg1:#0f1021; --bg2:#17182e; --text:#e9ecf1; --muted:#b7c3d6; --panel: rgba(20,24,38,.75);
      --card1: rgba(255,255,255,.10); --card2: rgba(255,255,255,.06); --link:#9ad1ff;
      --glass: rgba(255,255,255,.08); --glass-brd: rgba(255,255,255,.22);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(1200px 1200px at 20% -10%, #1a144622 0, transparent 60%),
                  radial-gradient(1200px 1200px at 120% 30%, #08263a22 0, transparent 60%),
                  linear-gradient(160deg,var(--bg1),var(--bg2));
      background-attachment: fixed;
    }

    /* Wallpaper */
    #fluid{ position:fixed; inset:0; z-index:-1; display:block;
      filter:saturate(120%) contrast(105%) blur(.2px); }

    header{
      max-width:1000px; margin:0 auto; padding:28px 16px 8px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    h1{margin:0; font-weight:900; font-size:clamp(22px,3vw,32px)}
    .sub{opacity:.9; color:var(--muted); font-size:.95rem}
    .controls{display:flex; gap:10px; flex-wrap:wrap}
    button{
      appearance:none; border:1px solid var(--glass-brd); background:var(--panel); color:var(--text);
      padding:10px 14px; border-radius:12px; font-weight:800; cursor:pointer; backdrop-filter: blur(10px);
      transition:.2s transform ease, .2s background-color ease; box-shadow: var(--shadow);
    }
    button:hover{transform:translateY(-1px)}
    button:focus-visible{outline:2px solid var(--accent); outline-offset:2px}
    .muted{opacity:.75; font-size:.9rem; color:var(--muted)}

    main{max-width:1000px; margin:8px auto 40px; padding:0 16px}
    /* Single column list: exactly one row per deadline */
    .list{ display:flex; flex-direction:column; gap:14px; }
    .row{
      border:1px solid var(--glass-brd);
      background:linear-gradient(180deg,var(--card1),var(--card2));
      border-radius:var(--radius); box-shadow: var(--shadow); overflow:hidden;
      padding:16px;
    }

    .head{display:flex; align-items:baseline; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .title{ font-weight:900; font-size:clamp(18px,2.2vw,24px) }
    .badge{ padding:6px 10px; border-radius:999px; font-size:.72rem; font-weight:900; letter-spacing:.4px;
            background:var(--glass); border:1px solid var(--glass-brd) }
    .due{ margin-top:6px; color:var(--muted); font-size:.96rem }

    .big{
      margin-top:10px;
      display:grid; grid-template-columns: repeat(8, minmax(0,1fr)); gap:10px; align-items:end;
    }
    .unit{
      grid-column: span 2; text-align:center; background: var(--glass);
      border:1px solid var(--glass-brd); border-radius:14px; padding:10px 8px;
    }
    @media (max-width:560px){ .unit{grid-column: span 4} }
    /* Make each countdown box center its contents */
    .unit{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    }

    /* Ensure digits stay centered and donâ€™t clip */
    .num{
    text-align:center;
    line-height:1;           /* avoids vertical crop */
    white-space:nowrap;      /* prevents wrapping */
    width:100%;
    display:block;
    }

    /* Give days a touch more room so large values donâ€™t overflow */
    .num[data-unit="days"]{ min-width: 5ch; } /* was 4ch */

    /* Non-squishy digits */
    .num{
      font-weight:900;
      font-size: clamp(44px, 9.5vw, 110px);
      line-height:.9; letter-spacing:.5px;
      font-variant-numeric: tabular-nums lining-nums;
      -moz-font-feature-settings: "tnum" 1, "lnum" 1;
      -webkit-font-feature-settings: "tnum" 1, "lnum" 1;
      font-feature-settings: "tnum" 1, "lnum" 1;
      display:inline-block; text-align:center;
    }
    .num[data-unit="days"]{ min-width:4ch; }   /* supports up to 9999d without reflow */
    .num[data-unit="hours"], .num[data-unit="mins"], .num[data-unit="secs"]{ min-width:2.4ch; }

    .lbl{opacity:.8; font-size:.85rem; font-weight:800; letter-spacing:.5px}
    .progress{ margin-top:10px; height:8px; border-radius:999px; background: var(--glass); overflow:hidden; border:1px solid var(--glass-brd) }
    .fill{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), #23c0ff)}
    .meta{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-top:8px}
    .status{font-weight:900; letter-spacing:.3px}
    .status.ok{color:var(--good)} .status.warn{color:var(--warn)} .status.bad{color:var(--bad)}
    .link{color:var(--link); text-decoration:none; font-weight:800}
    .link:hover{text-decoration:underline}
    .err{margin:14px 0 0; padding:10px 12px; border:1px solid #ff7d7f77; background:#380f12; color:#ffd9da; border-radius:12px; display:none}

    footer{opacity:.85; font-size:.9rem; text-align:center; margin:20px 0; color:var(--muted)}
    .pill{padding:.2rem .55rem; border-radius:999px; background:var(--glass); border:1px solid var(--glass-brd); font-weight:800}
  </style>
</head>
<body>
  <canvas id="fluid" aria-hidden="true"></canvas>

  <header>
    <div>
      <h1>Assignment Countdowns</h1>
      <div class="sub">Timezone: <span id="tz"></span></div>
      <div class="muted" id="stamp"></div>
    </div>
    <div class="controls">
      <button id="themeBtn" title="Toggle auto/dark/light">ðŸŒ“ Theme</button>
      <button id="bgBtn" title="Toggle fluid wallpaper">ðŸŒŠ Background</button>
      <button id="refreshBtn" title="Force reload JSON">ðŸ”„ Refresh</button>
    </div>
  </header>

  <main>
    <section id="list" class="list" aria-live="polite"></section>
    <div id="err" class="err" role="alert"></div>
  </main>

  <script>
    /******** CONFIG: Google Sheets CSV ********/
    // Your sheet: Title | Due Date | Time | Color
    // If your sheet tab uses a different gid, change the 0.
    const FETCH_URL = 'https://docs.google.com/spreadsheets/d/1WbNg5zyw2kpUwPO2SZjI3LFG8pE6WjeqOY_VNeyXWXg/export?format=csv&gid=0';

    /******** UTILITIES ********/
    const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
    const pad=(n)=>String(Math.floor(Math.abs(n))).padStart(2,'0');
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Local time';
    document.getElementById('tz').textContent = tz;

    function humanize(ms){
      const d=Math.floor(ms/86400000), h=Math.floor(ms%86400000/3600000), m=Math.floor(ms%3600000/60000);
      if(d>0) return `${d}d ${h}h`; if(h>0) return `${h}h ${m}m`; return `${m}m`;
    }
    function escapeHTML(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
    function escapeURL(s){try{new URL(s);return s;}catch{return '#';}}

    // Flexible local date parser for: M/D/YYYY [HH:MM[:SS]] [AM|PM] OR ISO-like
    function parseFlexible(s){
      try{
        s = String(s || '').trim();
        if(!s) return new Date('');
        // M/D/YYYY [HH:MM[:SS]] [AM|PM]
        const us = s.match(/^\s*(\d{1,2})\/(\d{1,2})\/(\d{4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?)?\s*$/i);
        if(us){
          let [,M,D,Y,h='0',mi='0',se='0',ampm] = us;
          h = parseInt(h,10);
          if(ampm){
            const up = ampm.toUpperCase();
            if(up==='PM' && h<12) h += 12;
            if(up==='AM' && h===12) h = 0;
          }
          return new Date(+Y, +M-1, +D, h, +mi, +(se||0), 0);
        }
        // YYYY-MM-DD[ T]HH:MM[:SS]
        const iso = s.match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2})(?::(\d{2}))?$/);
        if(iso){
          const [,Y,Mo,D,H,Mi,Se='0'] = iso;
          return new Date(+Y, +Mo-1, +D, +H, +Mi, +Se, 0);
        }
        // Fallback
        return new Date(s);
      }catch{ return new Date(''); }
    }

    // CSV parser (handles quotes/commas/newlines)
    function parseCSV(text){
      const rows=[]; let row=[], cell='', inQ=false;
      for(let i=0;i<text.length;i++){
        const c=text[i], n=text[i+1];
        if(c==='\"'){
          if(inQ && n==='\"'){ cell+='\"'; i++; }
          else inQ=!inQ;
        }else if(c===',' && !inQ){ row.push(cell); cell=''; }
        else if((c==='\n' || c==='\r') && !inQ){
          if(c==='\r' && n==='\n'){ i++; }
          row.push(cell); rows.push(row); row=[]; cell='';
        }else cell+=c;
      }
      if(cell.length>0 || row.length){ row.push(cell); rows.push(row); }
      return rows;
    }

    /******** STATE ********/
    const listEl=document.getElementById('list'), errEl=document.getElementById('err'), stamp=document.getElementById('stamp');
    let items=[]; const CACHE_KEY='deadlines-csv-cache-v1';

    /******** FETCH DEADLINES FROM GOOGLE SHEETS (CSV) ********/
    async function fetchDeadlines(force=false){
      try{
        const url = FETCH_URL + (FETCH_URL.includes('?') ? '&' : '?') + 't=' + Date.now(); // bust caches
        const res = await fetch(url, { cache:'no-store', mode:'cors' });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const csv = await res.text();
        localStorage.setItem(CACHE_KEY, csv);
        items = csvToItems(csv);
        render();
        stamp.textContent=`Last loaded: ${new Date().toLocaleString()}`;
        errEl.style.display='none';
      }catch(e){
        // fallback to cache
        const cached = localStorage.getItem(CACHE_KEY);
        if(cached){ items = csvToItems(cached); render(); }
        errEl.style.display='block';
        errEl.textContent=`Couldnâ€™t load the Google Sheet (${e.message}). Showing last known data if available.`;
      }
    }

    function csvToItems(csv){
      const rows = parseCSV(csv).filter(r=>r.some(x=>String(x).trim()!==''));
      if(rows.length===0) return [];
      const hdrs = rows[0].map(h=>String(h).trim().toLowerCase());
      const idx = {
        title: hdrs.indexOf('title'),
        date:  hdrs.indexOf('due date'),
        time:  hdrs.indexOf('time'),
        color: hdrs.indexOf('color'),
        link:  hdrs.indexOf('link'),
      };
      const out = [];
      for(let i=1;i<rows.length;i++){
        const r = rows[i];
        const title = (idx.title>-1 ? r[idx.title] : r[0]) || 'Untitled';
        const rawDate = idx.date>-1 ? r[idx.date] : '';
        const rawTime = idx.time>-1 ? r[idx.time] : '';
        const dueStr  = (String(rawDate).trim() + ' ' + String(rawTime).trim()).trim();
        const due     = parseFlexible(dueStr);
        if(isNaN(+due)) continue;
        const color = idx.color>-1 ? r[idx.color] : '';
        const link  = idx.link>-1  ? r[idx.link]  : '';
        out.push({
          title: String(title).trim(),
          due,
          color: color ? String(color).trim() : undefined,
          link: link ? String(link).trim() : undefined
        });
      }
      // at the end of csvToItems(csv)
    const cutoff = Date.now() - 24*3600*1000; // now - 1 day
    return out
    .filter(it => +it.due >= cutoff)       // drop anything >1 day overdue
    .sort((a,b)=>+a.due-+b.due)            // soonest first
    .slice(0,5);                           // keep up to 5
    }

    /******** RENDER (ONE ROW PER DEADLINE) ********/
    function render(){
      listEl.innerHTML='';
      const now=Date.now();
      for(const it of items){
        const due=+it.due;
        const ms=due-now, abs=Math.abs(ms);
        const d=Math.floor(abs/86400000), h=Math.floor(abs%86400000/3600000),
              m=Math.floor(abs%3600000/60000), s=Math.floor(abs%60000/1000);

        const soon = ms>0 && ms<48*3600000;
        const statusClass = ms<0 ? 'bad' : (soon ? 'warn' : 'ok');
        const statusText  = ms<0 ? 'OVERDUE' : (soon ? 'Due soon' : 'On track');

        const windowSize=7*24*3600000;
        const prog= ms<0 ? 100 : clamp(100 - ((due-now)/windowSize)*100,0,100);

        const fmt=new Intl.DateTimeFormat([],{
          year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit',hour12:false,timeZoneName:'short'
        }).format(new Date(due));

        const row=document.createElement('article');
        row.className='row';
        row.style.setProperty('--accent', it.color||'#7c5cff');
        if(ms<0) row.style.borderColor='rgba(255,77,79,.6)';

        row.innerHTML=`
          <div class="head">
            <div class="title" style="color:${it.color||'#7c5cff'}">ðŸ§­ ${escapeHTML(it.title)}</div>
            <span class="badge">${statusText}</span>
          </div>
          <div class="due">Due: <strong>${fmt}</strong></div>

          <div class="big" role="group" aria-label="time remaining">
            <div class="unit">
              <div class="num" data-unit="days">${pad(d)}</div>
              <div class="lbl">days</div>
            </div>
            <div class="unit">
              <div class="num" data-unit="hours">${pad(h)}</div>
              <div class="lbl">hours</div>
            </div>
            <div class="unit">
              <div class="num" data-unit="mins">${pad(m)}</div>
              <div class="lbl">mins</div>
            </div>
            <div class="unit">
              <div class="num" data-unit="secs">${pad(s)}</div>
              <div class="lbl">secs</div>
            </div>
          </div>

          <div class="progress" aria-hidden="true"><div class="fill" style="width:${prog}%"></div></div>

          <div class="meta">
            <div class="status ${statusClass}">${statusText}${ms<0 ? ' by ' : ' in '} ${humanize(abs)}</div>
            ${it.link ? `<a class="link" href="${escapeURL(it.link)}" target="_blank" rel="noopener">Open brief â†—</a>`:''}
          </div>
        `;
        listEl.appendChild(row);
      }
    }

    /******** TICK + CONTROLS ********/
    document.getElementById('refreshBtn').onclick=()=>fetchDeadlines(true);
    fetchDeadlines(true);
    setInterval(()=>render(),1000);          // live countdown tick
    setInterval(()=>fetchDeadlines(false),30000); // poll for updates

    /******** THEME TOGGLE ********/
    const THEME_KEY='countdown-theme';
    const root=document.documentElement;
    function applyTheme(v){ root.setAttribute('data-theme',v); localStorage.setItem(THEME_KEY,v); }
    (function initTheme(){ applyTheme(localStorage.getItem(THEME_KEY)||'auto'); })();
    document.getElementById('themeBtn').onclick=()=>{
      const cur=root.getAttribute('data-theme')||'auto';
      applyTheme(cur==='auto'?'dark':cur==='dark'?'light':'auto');
    };


const BG_KEY = 'countdown-bg';
const canvas = document.getElementById('fluid');
const ctx = canvas.getContext('2d', { alpha: true });
let raf = null, started = false, t0 = 0;

function resize() {
  const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  const w = canvas.clientWidth = window.innerWidth;
  const h = canvas.clientHeight = window.innerHeight;
  canvas.width = Math.floor(w * dpr);
  canvas.height = Math.floor(h * dpr);
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
}
window.addEventListener('resize', resize, { passive: true });
resize();

function loop(ts) {
  if (!started) t0 = ts;
  started = true;
  const t = (ts - t0) / 1000;
  const w = canvas.clientWidth, h = canvas.clientHeight;
  ctx.clearRect(0, 0, w, h);

  // Background spacey gradient
  const grd = ctx.createRadialGradient(w/2, h/2, 0, w/2, h/2, Math.max(w,h)/1.5);
  grd.addColorStop(0, 'rgba(5,5,25,0.6)');
  grd.addColorStop(1, 'rgba(0,0,0,1)');
  ctx.fillStyle = grd;
  ctx.fillRect(0, 0, w, h);

  ctx.globalCompositeOperation = 'lighter';

  // Trippy blobs
  const blobs = [
    { r: Math.min(w, h) * 0.35, sx: 0.2, sy: 0.3, sp: 0.25, c: 'rgba(0,255,255,0.15)' },
    { r: Math.min(w, h) * 0.4, sx: 0.8, sy: 0.4, sp: 0.18, c: 'rgba(255,0,255,0.14)' },
    { r: Math.min(w, h) * 0.3, sx: 0.5, sy: 0.8, sp: 0.22, c: 'rgba(124,92,255,0.15)' },
    { r: Math.min(w, h) * 0.25, sx: 0.6, sy: 0.2, sp: 0.35, c: 'rgba(0,255,128,0.13)' },
    { r: Math.min(w, h) * 0.2, sx: 0.4, sy: 0.6, sp: 0.4, c: 'rgba(255,255,0,0.12)' }
  ];

  for (const b of blobs) {
    const x = w * (b.sx + 0.1 * Math.sin(t * b.sp * 2 + b.r) + 0.02 * Math.cos(t * 0.5));
    const y = h * (b.sy + 0.1 * Math.cos(t * b.sp * 1.6 - b.r) + 0.03 * Math.sin(t * 0.8));
    const distortion = 1 + 0.1 * Math.sin(t * 3 + b.r); // fluidy pulse
    const radius = b.r * distortion;

    const rg = ctx.createRadialGradient(x, y, 0, x, y, radius);
    rg.addColorStop(0, b.c);
    rg.addColorStop(1, 'rgba(0,0,0,0)');

    ctx.fillStyle = rg;
    ctx.beginPath();
    ctx.arc(x, y, radius, 0, Math.PI * 2);
    ctx.fill();
  }

  ctx.globalCompositeOperation = 'source-over';
  raf = requestAnimationFrame(loop);
}

function startBG() {
  if (raf) cancelAnimationFrame(raf);
  canvas.style.display = 'block';
  raf = requestAnimationFrame(loop);
}
function stopBG() {
  if (raf) cancelAnimationFrame(raf);
  raf = null;
  started = false;
  canvas.style.display = 'none';
}

const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
function applyBG(v) {
  localStorage.setItem(BG_KEY, v);
  if (v === 'off' || (v === 'auto' && prefersReduced)) stopBG();
  else startBG();
}
(function initBG() {
  applyBG(localStorage.getItem(BG_KEY) || 'auto');
})();
document.getElementById('bgBtn').onclick = () => {
  const cur = localStorage.getItem(BG_KEY) || 'auto';
  applyBG(cur === 'auto' ? 'on' : cur === 'on' ? 'off' : 'auto');
};

    document.getElementById('bgBtn').onclick=()=>{
      const cur=localStorage.getItem(BG_KEY)||'auto';
      applyBG(cur==='auto'?'on':cur==='on'?'off':'auto');
    };

    // Initial stamp
    stamp.textContent = `Loaded: ${new Date().toLocaleString()}`;
  </script>
</body>
</html>
