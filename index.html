<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Assignment Countdown</title>
  <meta name="color-scheme" content="dark light" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#0f1021; --bg2:#17182e; --accent:#7c5cff; --good:#00c896; --warn:#ffb020; --bad:#ff4d4f;
      --glass: rgba(255,255,255,.10); --glass-brd: rgba(255,255,255,.25); --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:#e9ecf1;
      background: radial-gradient(1200px 1200px at 20% -10%, #1a1446 0, transparent 60%),
                  radial-gradient(1200px 1200px at 120% 30%, #08263a 0, transparent 60%),
                  linear-gradient(160deg,var(--bg1),var(--bg2));
      background-attachment: fixed;
    }
    header{
      padding:28px 18px 8px; display:flex; align-items:center; justify-content:space-between; gap:12px;
      max-width:1200px; margin:0 auto;
    }
    h1{margin:0; font-weight:800; letter-spacing:.4px; font-size:clamp(22px,3vw,32px)}
    .sub{opacity:.8; font-size:.95rem}
    .controls{display:flex; gap:10px; flex-wrap:wrap}
    .muted{opacity:.7; font-size:.9rem}
    button{
      appearance:none; border:1px solid var(--glass-brd); background:var(--glass); color:inherit;
      padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer; backdrop-filter: blur(8px);
      transition:.2s transform ease, .2s background-color ease, .2s border-color ease; box-shadow: var(--shadow);
    }
    button:hover{transform:translateY(-1px)}
    button:focus-visible{outline:2px solid var(--accent); outline-offset:2px}

    main{max-width:1200px; margin:8px auto 40px; padding:0 18px}
    .grid{ display:grid; gap:16px; grid-template-columns: repeat(12, 1fr); grid-auto-rows: 1fr; }
    .card{grid-column: span 12}
    @media (min-width:800px){
      .card:nth-child(1), .card:nth-child(2){grid-column: span 12}
      .card{grid-column: span 6}
    }
    .card{
      position:relative; border:1px solid var(--glass-brd); background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      padding:18px 18px 16px; border-radius:20px; backdrop-filter: blur(10px);
      box-shadow: var(--shadow); display:flex; flex-direction:column; gap:6px; overflow:hidden;
    }
    .badge{
      position:absolute; top:10px; right:10px; padding:6px 10px; border-radius:999px;
      font-size:.75rem; font-weight:700; letter-spacing:.4px; background:rgba(255,255,255,.14); border:1px solid var(--glass-brd)
    }
    .title{ display:flex; align-items:baseline; gap:10px; flex-wrap:wrap; font-weight:800; font-size: clamp(18px, 2.2vw, 24px); }
    .title .subject{opacity:.9}
    .due{ opacity:.85; font-size:.95rem; }
    .big{ margin-top:6px; display:grid; grid-template-columns: repeat(8, minmax(0,1fr)); gap:10px; align-items:end; }
    .unit{
      grid-column: span 2; text-align:center; background: rgba(255,255,255,.08);
      border:1px solid var(--glass-brd); border-radius:16px; padding:10px 8px;
    }
    @media (max-width:500px){ .unit{grid-column: span 4} }
    .num{ font-weight:800; font-size: clamp(42px, 9.5vw, 120px); line-height: .9; letter-spacing:.5px; }
    .lbl{opacity:.8; font-size:.85rem; font-weight:600; letter-spacing:.5px}
    .progress{ margin-top:10px; height:8px; border-radius:999px; background: rgba(255,255,255,.10); overflow:hidden; border:1px solid var(--glass-brd) }
    .fill{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), #23c0ff)}
    .meta{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between}
    .status{font-weight:700; letter-spacing:.3px}
    .status.ok{color:var(--good)} .status.warn{color:var(--warn)} .status.bad{color:var(--bad)}
    .link{color:#9ad1ff; text-decoration:none; font-weight:600}
    .link:hover{text-decoration:underline}
    .err{margin:16px 0 0; padding:10px 12px; border:1px solid #ff7d7f77; background:#380f12; color:#ffd9da; border-radius:12px; display:none}
    footer{opacity:.7; font-size:.9rem; text-align:center; margin:24px 0}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Assignment Countdown</h1>
      <div class="sub">Server-managed. Auto-sorted. Your timezone: <span id="tz"></span></div>
      <div class="muted" id="stamp"></div>
    </div>
    <div class="controls">
      <button id="refreshBtn" title="Force refresh from server">ðŸ”„ Refresh</button>
    </div>
  </header>

  <main>
    <section id="grid" class="grid" aria-live="polite"></section>
    <div id="err" class="err" role="alert"></div>
    <footer>To update deadlines, edit <code>deadlines.json</code> in the repo. Viewers canâ€™t change it.</footer>
  </main>

  <script>
    // ---------- Utilities ----------
    const pad = (n) => String(Math.floor(Math.abs(n))).padStart(2,'0');
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
    const bySoonest = (a,b) => +new Date(a.due) - +new Date(b.due);
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Local time';
    document.getElementById('tz').textContent = tz;

    // ---------- State ----------
    const grid = document.getElementById('grid');
    const errEl = document.getElementById('err');
    const stamp = document.getElementById('stamp');
    let items = [];
    let etag = null;

    // ---------- Fetch server JSON ----------
    async function fetchDeadlines(force = false){
      try{
        const headers = {'cache-control':'no-cache'};
        if(etag && !force) headers['If-None-Match'] = etag; // browsers may ignore; harmless
        const res = await fetch('deadlines.json', {cache:'no-cache', headers});
        if(res.status === 304) return; // unchanged
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        etag = res.headers.get('ETag') || etag;
        const arr = await res.json();
        items = sanitize(arr).slice(0,5).sort(bySoonest);
        render();
        stamp.textContent = `Last loaded: ${new Date().toLocaleString()}`;
        errEl.style.display = 'none';
      }catch(e){
        errEl.style.display = 'block';
        errEl.textContent = `Couldnâ€™t load deadlines.json (${e.message}). Your last loaded data will continue to display.`;
      }
    }

    function sanitize(arr){
      return (Array.isArray(arr)?arr:[]).filter(Boolean).map(o=>{
        const title = (o.title??'').toString().trim() || 'Untitled';
        const due = new Date(o.due);
        const ok = !isNaN(+due);
        return {
          title,
          due: ok ? due.toISOString().slice(0,16) : new Date(Date.now()+86400000).toISOString().slice(0,16),
          link: o.link ? String(o.link) : undefined,
          color: o.color ? String(o.color) : undefined
        };
      });
    }

    // ---------- Rendering ----------
    function render(){
      grid.innerHTML = '';
      const now = Date.now();
      for(const it of items){
        const due = new Date(it.due);
        const ms  = due - now;
        const abs = Math.abs(ms);
        const d = Math.floor(abs/86400000);
        const h = Math.floor(abs%86400000/3600000);
        const m = Math.floor(abs%3600000/60000);
        const s = Math.floor(abs%60000/1000);

        const soon = ms > 0 && ms < 48*3600000;
        const statusClass = ms < 0 ? 'bad' : soon ? 'warn' : 'ok';
        const statusText  = ms < 0 ? 'OVERDUE' : soon ? 'Due soon' : 'On track';

        const windowSize = 7*24*3600000;
        const prog = ms < 0 ? 100 : clamp(100 - ((due - now)/windowSize)*100, 0, 100);

        const fmt = new Intl.DateTimeFormat([], {
          year:'numeric', month:'short', day:'2-digit',
          hour:'2-digit', minute:'2-digit', hour12:false, timeZoneName:'short'
        }).format(due);

        const card = document.createElement('article');
        card.className = 'card';
        card.style.setProperty('--accent', it.color || '#7c5cff');
        if(ms<0) card.style.borderColor = 'rgba(255,77,79,.6)';

        card.innerHTML = `
          <span class="badge" style="border-color:${(it.color||'#7c5cff')}55">${statusText}</span>
          <div class="title" style="color:${it.color||'#7c5cff'}">
            <span>ðŸ§­</span><span class="subject">${escapeHTML(it.title)}</span>
          </div>
          <div class="due">Due: <strong>${fmt}</strong></div>
          <div class="big" role="group" aria-label="time remaining">
            <div class="unit"><div class="num">${pad(d)}</div><div class="lbl">days</div></div>
            <div class="unit"><div class="num">${pad(h)}</div><div class="lbl">hours</div></div>
            <div class="unit"><div class="num">${pad(m)}</div><div class="lbl">mins</div></div>
            <div class="unit"><div class="num">${pad(s)}</div><div class="lbl">secs</div></div>
          </div>
          <div class="progress" aria-hidden="true"><div class="fill" style="width:${prog}%"></div></div>
          <div class="meta">
            <div class="status ${statusClass}">${statusText}${ms<0 ? ' by ' : ' in '} ${humanize(abs)}</div>
            ${it.link ? `<a class="link" href="${escapeURL(it.link)}" target="_blank" rel="noopener">Open brief â†—</a>`:''}
          </div>
        `;
        grid.appendChild(card);
      }
    }

    function humanize(ms){
      const d = Math.floor(ms/86400000), h = Math.floor(ms%86400000/3600000), m = Math.floor(ms%3600000/60000);
      if(d>0) return `${d}d ${h}h`;
      if(h>0) return `${h}h ${m}m`;
      return `${m}m`;
    }

    function escapeHTML(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function escapeURL(s){ try{ new URL(s); return s; }catch{ return '#'; } }

    // ---------- Init + Live updates ----------
    document.getElementById('refreshBtn').onclick = ()=> fetchDeadlines(true);
    fetchDeadlines(true);
    setInterval(()=>render(), 1000);        // tick timers
    setInterval(()=>fetchDeadlines(false), 30000); // poll server every 30s
  </script>
</body>
</html>
